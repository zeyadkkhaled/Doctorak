{% load static %}
<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>Doctorak - Doctor Booking</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'styles/home.css' %}">
    <link rel="icon" href="{% static 'imgs/logoso88.png' %}" type="image/x-icon"/>
</head>
<body data-user-authenticated="{{ request.user.is_authenticated|lower }}" data-user-role="{{ request.user.get_role }}">
<my-header></my-header>

<!-- Specialties Section -->
<div class="container mt-5">
    <div class="row gy-4">
        <div class="col-6 col-md-3">
            <a href="{% url 'doctor_list' %}?specialty={{ 'Pediatrics & Newborn'|urlencode }} "
               style="text-decoration: none;color:black ">
                <div class="specialty-card text-center p-3">
                    <img src="{% static 'imgs/baby-boy.png' %}" alt="Pediatrics">
                    <h6 class="mt-2">Pediatrics & Newborn</h6>
                    <p class="text-muted">{{ specialty_counts.Pediatrics|default:"0" }} doctors</p>
                </div>
            </a>
        </div>

        <div class="col-6 col-md-3">
            <a href="{% url 'doctor_list' %}?specialty={{ 'Internal Medicine'|urlencode }} "
               style="text-decoration: none;color:black ">
                <div class="specialty-card text-center p-3">
                    <img src="{% static 'imgs/guts.png' %}" alt="Internal Medicine">
                    <h6 class="mt-2">Internal Medicine</h6>
                    <p class="text-muted">{{ specialty_counts.Internal_Medicine|default:"0" }} doctors</p>
                </div>
            </a>
        </div>

        <div class="col-6 col-md-3">
            <a href="{% url 'doctor_list' %}?specialty={{ 'Obstetrics & Gynecology'|urlencode }}"
               style="text-decoration: none;color:black ">
                <div class="specialty-card text-center p-3">
                    <img src="{% static 'imgs/obstetrics-and-gynecology-blue-concept-icon-2F3N278.jpg' %}"
                         alt="Obstetrics">
                    <h6 class="mt-2">Obstetrics & Gynecology</h6>
                    <p class="text-muted">{{ specialty_counts.Obstetrics_Gynecology|default:"0" }} doctors</p>
                </div>
            </a>
        </div>

        <div class="col-6 col-md-3">
            <a href="{% url 'doctor_list' %}?specialty={{ 'Dentistry'|urlencode }}"
               style="text-decoration: none;color:black ">
                <div class="specialty-card text-center p-3">
                    <img src="{% static 'imgs/tooth.png' %}" alt="Dentistry">
                    <h6 class="mt-2">Dentistry</h6>
                    <p class="text-muted">{{ specialty_counts.Dentistry|default:"0" }} doctors</p>
                </div>
            </a>
        </div>

        <div class="col-6 col-md-3">
            <a href="{% url 'doctor_list' %}?specialty={{ 'Cardiology'|urlencode }}"
               style="text-decoration: none;color:black ">
                <div class="specialty-card text-center p-3">
                    <img src="{% static 'imgs/heart.png' %}" alt="Cardiology">
                    <h6 class="mt-2">Cardiology</h6>
                    <p class="text-muted">{{ specialty_counts.Cardiology|default:"0" }} doctors</p>
                </div>
            </a>
        </div>

        <div class="col-6 col-md-3">
            <a href="{% url 'doctor_list' %}?specialty={{ 'Orthopedics'|urlencode }}"
               style="text-decoration: none;color:black ">
                <div class="specialty-card text-center p-3">
                    <img src="{% static 'imgs/bone.png' %}" alt="Orthopedics">
                    <h6 class="mt-2">Orthopedics</h6>
                    <p class="text-muted">{{ specialty_counts.Orthopedics|default:"0" }} doctors</p>
                </div>
            </a>
        </div>

        <div class="col-6 col-md-3">
            <a href="{% url 'doctor_list' %}?specialty={{ 'ENT'|urlencode }}"
               style="text-decoration: none;color:black ">
                <div class="specialty-card text-center p-3">
                    <img src="{% static 'imgs/ear.png' %}" alt="ENT">
                    <h6 class="mt-2">ENT</h6>
                    <p class="text-muted">{{ specialty_counts.ENT|default:"0" }} doctors</p>
                </div>
            </a>
        </div>

        <div class="col-6 col-md-3">
            <a href="{% url 'doctor_list' %}?specialty={{ 'General Surgery'|urlencode }}"
               style="text-decoration: none;color:black ">
                <div class="specialty-card text-center p-3">
                    <img src="{% static 'imgs/surgery.png' %}" alt="Surgery">
                    <h6 class="mt-2">General Surgery</h6>
                    <p class="text-muted">{{ specialty_counts.General_Surgery|default:"0" }} doctors</p>
                </div>
            </a>
        </div>

        <div class="col-6 col-md-3">
            <a href="{% url 'doctor_list' %}?specialty={{ 'Neurology'|urlencode }}"
               style="text-decoration: none;color:black ">
                <div class="specialty-card text-center p-3">
                    <img src="{% static 'imgs/brain.png' %}" alt="Neurology">
                    <h6 class="mt-2">Neurology</h6>
                    <p class="text-muted">{{ specialty_counts.Neurology|default:"0" }} doctors</p>
                </div>
            </a>
        </div>

        <div class="col-6 col-md-3">
            <a href="{% url 'doctor_list' %}?specialty={{ 'Dermatology'|urlencode }}"
               style="text-decoration: none;color:black ">
                <div class="specialty-card text-center p-3">
                    <img src="{% static 'imgs/beauty.png' %}" alt="Dermatology">
                    <h6 class="mt-2">Dermatology</h6>
                    <p class="text-muted">{{ specialty_counts.Dermatology|default:"0" }} doctors</p>
                </div>
            </a>
        </div>

        <div class="col-6 col-md-3">
            <a href="{% url 'doctor_list' %}?specialty={{ 'Ophthalmology'|urlencode }}"
               style="text-decoration: none;color:black ">
                <div class="specialty-card text-center p-3">
                    <img src="{% static 'imgs/eye-examination.png' %}" alt="Ophthalmology">
                    <h6 class="mt-2">Ophthalmology</h6>
                    <p class="text-muted">{{ specialty_counts.Ophthalmology|default:"0" }} doctors</p>
                </div>
            </a>
        </div>

        <div class="col-6 col-md-3">
            <a href="{% url 'doctor_list' %}?specialty={{ 'Oncology'|urlencode }}"
               style="text-decoration: none;color:black ">
                <div class="specialty-card text-center p-3">
                    <img src="{% static 'imgs/images.png' %}" alt="Oncology">
                    <h6 class="mt-2">Oncology</h6>
                    <p class="text-muted">{{ specialty_counts.Oncology|default:"0" }} doctors</p>
                </div>
            </a>
        </div>
    </div>
</div>

<!-- Doctor Invitation -->
<div class="doctor-section">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-md-6 text-start">
                <h3 class="text-dark fw-bold">Are You a Doctor?</h3>
                <p>Join Doctorak platform and gain fast exposure for your clinic and benefit from our premium
                    services.</p>
                <a href="/register/" class="btn btn-light mt-2">
                    <i class="bi bi-person-plus"></i> Add Your Clinic on Doctorak Platform
                </a>
            </div>
            <div class="col-md-6 text-end">
                <img src="{% static 'imgs/logokb.png' %}" alt="Doctor" class="img-fluid" style="max-width: 250px;">
            </div>
        </div>
    </div>
</div>

<!-- Latest Articles -->
<div class="container my-5">
    <h3 class="mb-4 fw-bold" style="color: #00c4b4;">Latest Articles</h3>
    <div class="row row-cols-1 row-cols-md-3 g-4 articles">
        <div class="col">
            <div class="card h-100">
                <img src="{% static 'imgs/wg3 batn.jpeg' %}" class="card-img-top" alt="Stomach Pain">
                <div class="card-body">
                    <h5 class="card-title" style="color: #00c4b4;">Sudden Stomach Pain & Main Causes</h5>
                    <p class="card-text">Stomach pain can appear suddenly and is often due to indigestion or acidity.
                        But it's important to know when to see a doctor...</p>
                    <a href="/articles.html#article-1" class="text-success">Read Full Article</a>
                </div>
            </div>
        </div>
        <div class="col">
            <div class="card h-100">
                <img src="{% static 'imgs/wg3 ras.jpg' %}" class="card-img-top" alt="High Body Temperature">
                <div class="card-body">
                    <h5 class="card-title" style="color: #00c4b4;">Serious Causes of High Body Temperature and Their
                        Symptoms</h5>
                    <p class="card-text">Evaluating whether a high body temperature is dangerous for adults or children
                        involves more than just focusing on the number...</p>
                    <a href="/articles.html#article-2" class="text-success">Read Full Article</a>
                </div>
            </div>
        </div>
        <div class="col">
            <div class="card h-100">
                <img src="{% static 'imgs/wg3 alb.jpg' %}" class="card-img-top" alt="Chest Pain">
                <div class="card-body">
                    <h5 class="card-title" style="color: #00c4b4;">5 Causes Behind Chest Pain</h5>
                    <p class="card-text">Chest pain is often alarming as it may indicate heart conditions or other
                        serious issues. Learn about the common causes...</p>
                    <a href="/articles.html#article-3" class="text-success">Read Full Article</a>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- Add this right before the closing </body> tag in home.html -->
<div class="chatbot-container">
    <div class="chatbot-header">
        <h5>Doctorak Assistant</h5>
        <button class="btn-close btn-close-white close-chatbot"></button>
    </div>
    <div class="chatbot-messages" id="chatbot-messages">
        <div class="bot-message">
            <p>Hello! I'm Doctorak Assistant. How can I help you today?</p>
            <p>You can describe your symptoms, ask about specialties, or book an appointment.</p>
        </div>
    </div>
    <div class="quick-actions">
        <button class="quick-btn" data-action="symptoms">Check Symptoms</button>
        <button class="quick-btn" data-action="book">Book Appointment</button>
        <button class="quick-btn" data-action="specialties">View Specialties</button>
    </div>
    <div class="chatbot-input">
        <textarea id="chatbot-input" placeholder="Type your message here..."></textarea>
        <button id="send-message"><i class="bi bi-send-fill"></i></button>
    </div>
</div>
<button class="chatbot-toggle">
    <i class="bi bi-robot"></i>
</button>


<my-footer></my-footer>

<!-- External Scripts -->
<script>
    const CSRF_TOKEN = "{{ csrf_token }}";
    const LOGIN_URL = "{{ login_url }}";
    const static_url = "{% static '' %}";
    const DOCTOR_LIST_URL = "{% url 'doctor_list' %}";
    const USER_ID = "{{ request.user.id|default_if_none:'' }}";
    const IS_AUTHENTICATED = document.body.getAttribute('data-user-authenticated') === 'true';
</script>
<script>
    // Chatbot main functionality with debug logging
    document.addEventListener('DOMContentLoaded', function () {
    console.debug('Chatbot initializing with debug logging...');

    // Elements
    const chatbotToggle = document.querySelector('.chatbot-toggle');
    const chatbotContainer = document.querySelector('.chatbot-container');
    const sendButton = document.getElementById('send-message');
    const chatInput = document.getElementById('chatbot-input');
    const chatMessages = document.getElementById('chatbot-messages');
    const quickButtons = document.querySelectorAll('.quick-btn');

    // Toggle chatbot visibility
    chatbotToggle.addEventListener('click', function () {
        console.debug('Toggling chatbot visibility');
        chatbotContainer.classList.toggle('active');
    });

    // Close chatbot
    document.querySelector('.close-chatbot').addEventListener('click', function () {
        console.debug('Closing chatbot');
        chatbotContainer.classList.remove('active');
    });

    // Send message function with enhanced error handling and logging
    async function sendMessage() {
        const message = chatInput.value.trim();
        if (!message) return;

        addMessage(message, 'user');
        chatInput.value = '';
        addTypingIndicator();

        try {
            console.debug('Sending message to server:', message);

            const payload = {
                message: message,
                user_id: USER_ID || null
            };

            console.debug('Request payload:', payload);

            const response = await fetch('/ai/chatbot/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': CSRF_TOKEN
                },
                body: JSON.stringify(payload),
                // Add these to get more info on errors
                credentials: 'same-origin'
            });

            console.debug('Response status:', response.status);

            if (!response.ok) {
                throw new Error(`Server responded with status: ${response.status}`);
            }

            const data = await response.json();
            console.debug('Server response data:', data);

            processBotResponse(data);
        } catch (error) {
            console.error('Error sending message:', error);
            showErrorMessage(`Connection error: ${error.message}`);
        } finally {
            removeTypingIndicator();
        }
    }

    // Process bot response with more detailed error handling
    function processBotResponse(data) {
        console.debug('Processing bot response:', data);

        if (!data) {
            showErrorMessage("Received empty response from server");
            return;
        }

        // Clear existing quick actions
        const quickActions = document.querySelector('.quick-actions');
        quickActions.innerHTML = '';

        // Add messages
        if (data.messages && data.messages.length) {
            data.messages.forEach(msg => {
                console.debug('Adding bot message:', msg);
                addMessage(msg, 'bot');
            });
        } else {
            console.warn('No messages received in response');
        }

        // Add actions
        if (data.actions && data.actions.length) {
            console.debug('Adding quick actions:', data.actions);
            data.actions.forEach(action => {
                const actionBtn = document.createElement('button');
                actionBtn.className = 'quick-btn';
                actionBtn.textContent = action.text;
                actionBtn.onclick = function () {
                    console.debug(`Action clicked: ${action.text}`);
                    if (action.url) {
                        window.location.href = action.url;
                    } else if (action.action) {
                        // Handle action buttons that trigger new chatbot messages
                        const quickPayload = {
                            action: action.action,
                            user_id: USER_ID || null
                        };
                        fetch('/ai/chatbot/', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': CSRF_TOKEN
                            },
                            body: JSON.stringify(quickPayload),
                            credentials: 'same-origin'
                        })
                            .then(response => {
                                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                                return response.json();
                            })
                            .then(processBotResponse)
                            .catch(error => {
                                console.error('Quick action error:', error);
                                showErrorMessage(`Action error: ${error.message}`);
                            });
                    }
                };
                quickActions.appendChild(actionBtn);
            });
        }
    }

    // Show error message
    function showErrorMessage(message) {
        console.error('Displaying error to user:', message);
        const errorDiv = document.createElement('div');
        errorDiv.className = 'bot-message error-message';
        errorDiv.innerHTML = `<p>‚ö†Ô∏è ${message}</p>`;
        chatMessages.appendChild(errorDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    // Message helpers
    function addMessage(text, sender) {
        console.debug(`Adding ${sender} message:`, text);
        const messageDiv = document.createElement('div');
        messageDiv.className = `${sender}-message`;
        messageDiv.innerHTML = `<p>${text.replace(/\n/g, '<br>')}</p>`;
        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function addTypingIndicator() {
        console.debug('Showing typing indicator');
        const typingDiv = document.createElement('div');
        typingDiv.id = 'typing-indicator';
        typingDiv.className = 'bot-message typing';
        typingDiv.innerHTML = '<div class="typing-dots"><span></span><span></span><span></span></div>';
        chatMessages.appendChild(typingDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function removeTypingIndicator() {
        console.debug('Removing typing indicator');
        const typingIndicator = document.getElementById('typing-indicator');
        if (typingIndicator) typingIndicator.remove();
    }

    // Quick actions with enhanced error handling
    quickButtons.forEach(button => {
        button.addEventListener('click', function () {
            const action = this.getAttribute('data-action');
            console.debug(`Quick button clicked: ${action}`);

            if (action === "book" && !IS_AUTHENTICATED) {
                processBotResponse({
                    messages: ["üîí Please login to book appointments."],
                    actions: [
                        {text: "üîë Login", url: LOGIN_URL},
                        {text: "üìù Register", url: "/register/"}
                    ]
                });
                return;
            }

            if (action === "book") {
                processBotResponse({
                    messages: [
                        "üìÖ To book an appointment:",
                        "1. Tell me when (e.g., 'tomorrow at 2 PM')",
                        "2. I'll show available doctors",
                        "3. Select your preferred doctor"
                    ],
                    actions: []
                });
                return;
            }

            // Handle other actions normally
            const quickPayload = {
                action: action,
                user_id: USER_ID || null
            };

            console.debug('Sending quick action payload:', quickPayload);

            fetch('/ai/chatbot/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': CSRF_TOKEN
                },
                body: JSON.stringify(quickPayload),
                credentials: 'same-origin'
            })
                .then(response => {
                    console.debug('Quick action response status:', response.status);
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    return response.json();
                })
                .then(data => {
                    console.debug('Quick action response data:', data);
                    processBotResponse(data);
                })
                .catch(error => {
                    console.error('Quick action error:', error);
                    showErrorMessage(`Couldn't process action: ${error.message}`);
                });
        });
    });

    // Event listeners
    sendButton.addEventListener('click', sendMessage);

    chatInput.addEventListener('keydown', function (e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });

    console.debug('Chatbot initialized successfully');
});
</script>
<script src="{% static 'script/home.js' %}"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>


</body>
</html>
